@startuml to be

== Юзер оформляет подписку ==

autonumber

actor User

User -> Frontend: Нажал кнопку "Оформить подписку"

Frontend -> BillingAPI: Запрос на офрмление подписки

BillingAPI -> BillingAPI: Проверяет токен юзера

BillingAPI -> TransactionsDB: Сохраняем детали платежа, план подписки, срок действия и payment_id

TransactionsDB --> BillingAPI: Ok

BillingAPI --> User: Редирект на страницу оплаты

User -> ExternalPaymentService: Вводит данные карты совершает платеж

par Паралельное выполнение

ExternalPaymentService --> Frontend: Редирект на страницу кинотеатра

ExternalPaymentService -> BillingAPI: Уведомление о совершенном платеже (вебхук)

end

BillingAPI -> TransactionsDB: Меняем статус платежа на "Успех"

TransactionsDB --> BillingAPI: Ok

par Паралельное выполнение

BillingAPI --> ExternalPaymentService: HTTP status 200 Ok

BillingAPI -> Auth: Меняем права пользователя

end

Auth --> BillingAPI: Ok

BillingAPI -> Notifications: Отправить уведомление юзеру о подписке

par

Notifications --> BillingAPI: Ok

Notifications -> User: Уведомление

end

@enduml